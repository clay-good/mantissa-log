name: Credential Compromise Response
description: |
  Automated response playbook for credential compromise incidents.
  Disables the affected user account, revokes active sessions,
  and notifies the security team.

version: "1.0.0"
status: active

trigger:
  type: alert
  conditions:
    rule_id: "credential_compromise_*"
    severity:
      - high
      - critical
    tags:
      - credential
      - compromise

steps:
  - id: step-1
    name: Disable User Account
    action_type: disable_user
    description: Immediately disable the compromised user account to prevent further unauthorized access
    parameters:
      user_id: "{{alert.user_id}}"
      reason: "Automated response to credential compromise alert"
      provider: "{{alert.identity_provider | default('okta')}}"
    requires_approval: required
    approval_timeout_seconds: 3600
    on_failure: stop

  - id: step-2
    name: Revoke All Active Sessions
    action_type: revoke_sessions
    description: Terminate all active sessions for the compromised user
    parameters:
      user_id: "{{alert.user_id}}"
      include_refresh_tokens: true
    depends_on:
      - step-1
    on_failure: continue

  - id: step-3
    name: Force Password Reset
    action_type: reset_password
    description: Force a password reset for the user account
    parameters:
      user_id: "{{alert.user_id}}"
      send_notification: true
      notification_method: email
    depends_on:
      - step-1
    on_failure: continue

  - id: step-4
    name: Revoke API Keys
    action_type: revoke_api_keys
    description: Revoke all API keys and tokens associated with the user
    parameters:
      user_id: "{{alert.user_id}}"
      scope: all
    depends_on:
      - step-1
    on_failure: continue

  - id: step-5
    name: Create Incident Ticket
    action_type: create_ticket
    description: Create an incident ticket in the ticketing system
    parameters:
      system: "{{settings.ticketing_system | default('jira')}}"
      project: "SEC"
      issue_type: Incident
      priority: High
      title: "Credential Compromise: {{alert.user_id}}"
      description: |
        A credential compromise was detected for user {{alert.user_id}}.

        Alert Details:
        - Alert ID: {{alert.id}}
        - Rule: {{alert.rule_name}}
        - Source IP: {{alert.source_ip}}
        - Timestamp: {{alert.timestamp}}

        Automated actions taken:
        - User account disabled
        - Active sessions revoked
        - Password reset initiated
        - API keys revoked
      labels:
        - security-incident
        - credential-compromise
        - automated-response
    depends_on:
      - step-1
    on_failure: continue

  - id: step-6
    name: Notify Security Team
    action_type: send_notification
    description: Send notification to the security team via Slack
    parameters:
      channel: "{{settings.security_channel | default('#security-alerts')}}"
      message: |
        :rotating_light: *Credential Compromise Response Initiated*

        *User:* {{alert.user_id}}
        *Alert:* {{alert.rule_name}}
        *Source IP:* {{alert.source_ip}}
        *Time:* {{alert.timestamp}}

        *Actions Completed:*
        - User account disabled
        - Sessions revoked
        - Password reset sent
        - API keys revoked
        - Incident ticket created

        <{{execution.ticket_url}}|View Incident Ticket>
      mentions:
        - "@security-oncall"
    depends_on:
      - step-5
    on_failure: continue

  - id: step-7
    name: Collect User Activity Logs
    action_type: run_script
    description: Collect recent activity logs for forensic analysis
    parameters:
      script: collect_user_activity.py
      args:
        user_id: "{{alert.user_id}}"
        time_range: 24h
        output_bucket: "{{settings.forensics_bucket}}"
    depends_on:
      - step-1
    timeout_seconds: 600
    on_failure: continue

tags:
  - credential
  - compromise
  - identity
  - automated-response

metadata:
  author: Security Team
  created_at: "2024-01-15T00:00:00Z"
  updated_at: "2024-01-20T00:00:00Z"
  review_status: approved
  compliance:
    - SOC2
    - ISO27001
