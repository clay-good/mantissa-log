name: Malware Detection Response
description: |
  Automated response playbook for malware detection alerts.
  Isolates the affected host, collects forensic data,
  and initiates incident response procedures.

version: "1.0.0"
status: active

trigger:
  type: alert
  conditions:
    rule_id: "malware_*"
    tags:
      - malware
      - endpoint

steps:
  - id: step-1
    name: Isolate Infected Host
    action_type: isolate_host
    description: Immediately isolate the host from the network to prevent lateral movement
    parameters:
      host_id: "{{alert.host_id}}"
      host_ip: "{{alert.host_ip}}"
      isolation_level: full
      allow_security_tools: true
      reason: "Malware detected - automated isolation"
    requires_approval: required
    approval_timeout_seconds: 1800
    on_failure: stop

  - id: step-2
    name: Block Malicious IP
    action_type: block_ip
    description: Block communication with identified malicious IP addresses
    parameters:
      ip_address: "{{alert.malicious_ip}}"
      duration: permanent
      firewall_zones:
        - perimeter
        - internal
      reason: "Associated with malware C2 communication"
    depends_on:
      - step-1
    on_failure: continue
    condition: "{{alert.malicious_ip is defined}}"

  - id: step-3
    name: Block Malicious Domain
    action_type: block_domain
    description: Block DNS resolution for malicious domains
    parameters:
      domain: "{{alert.malicious_domain}}"
      block_type: sinkhole
      reason: "Malware C2 domain"
    depends_on:
      - step-1
    on_failure: continue
    condition: "{{alert.malicious_domain is defined}}"

  - id: step-4
    name: Collect Memory Dump
    action_type: collect_forensics
    description: Collect memory dump from infected host for analysis
    parameters:
      host_id: "{{alert.host_id}}"
      collection_type: memory
      output_bucket: "{{settings.forensics_bucket}}"
      encrypt: true
    depends_on:
      - step-1
    timeout_seconds: 1800
    on_failure: continue

  - id: step-5
    name: Collect Disk Image
    action_type: collect_forensics
    description: Collect disk image for forensic analysis
    parameters:
      host_id: "{{alert.host_id}}"
      collection_type: disk
      output_bucket: "{{settings.forensics_bucket}}"
      encrypt: true
      compress: true
    depends_on:
      - step-4
    timeout_seconds: 7200
    on_failure: continue

  - id: step-6
    name: Query Related Hosts
    action_type: run_query
    description: Search for other potentially affected hosts
    parameters:
      query: |
        SELECT DISTINCT host_id, host_ip, last_seen
        FROM endpoint_logs
        WHERE (
          destination_ip = '{{alert.malicious_ip}}'
          OR dns_query LIKE '%{{alert.malicious_domain}}%'
          OR file_hash = '{{alert.file_hash}}'
        )
        AND timestamp > NOW() - INTERVAL 7 DAY
      store_results_as: related_hosts
    depends_on:
      - step-1
    on_failure: continue

  - id: step-7
    name: Create Incident Ticket
    action_type: create_ticket
    description: Create an incident ticket with all details
    parameters:
      system: jira
      project: SEC
      issue_type: Incident
      priority: Critical
      title: "Malware Incident: {{alert.host_id}}"
      description: |
        ## Malware Detection Incident

        **Host:** {{alert.host_id}} ({{alert.host_ip}})
        **Detection Time:** {{alert.timestamp}}
        **Alert ID:** {{alert.id}}

        ### Malware Details
        - **Type:** {{alert.malware_type | default('Unknown')}}
        - **File Hash:** {{alert.file_hash | default('N/A')}}
        - **File Path:** {{alert.file_path | default('N/A')}}
        - **C2 IP:** {{alert.malicious_ip | default('N/A')}}
        - **C2 Domain:** {{alert.malicious_domain | default('N/A')}}

        ### Automated Response Actions
        - [x] Host isolated from network
        - [x] Malicious IP/Domain blocked
        - [x] Memory dump collected
        - [x] Disk image collected

        ### Related Hosts
        {{#execution.related_hosts}}
        - {{host_id}} ({{host_ip}})
        {{/execution.related_hosts}}
      labels:
        - security-incident
        - malware
        - critical
        - automated-response
    depends_on:
      - step-6
    on_failure: continue

  - id: step-8
    name: Page Security Team
    action_type: send_notification
    description: Page the security team for immediate response
    parameters:
      service: pagerduty
      severity: critical
      title: "Malware Incident - Immediate Response Required"
      description: |
        Malware detected on {{alert.host_id}}.
        Host has been isolated.
        Forensic collection in progress.
        Review incident ticket for details.
      dedup_key: "malware_{{alert.host_id}}_{{alert.timestamp | date('%Y%m%d')}}"
    depends_on:
      - step-1
    on_failure: continue

  - id: step-9
    name: Notify Slack Channel
    action_type: send_notification
    description: Notify the security Slack channel
    parameters:
      channel: "#security-incidents"
      message: |
        :biohazard_sign: *MALWARE INCIDENT - {{alert.severity | upper}}*

        *Host:* {{alert.host_id}} ({{alert.host_ip}})
        *Detection:* {{alert.rule_name}}
        *Time:* {{alert.timestamp}}

        *Status:* Host isolated, forensics being collected

        <{{execution.ticket_url}}|View Incident> | <{{alert.dashboard_url}}|View in Dashboard>
    depends_on:
      - step-7
    on_failure: continue

  - id: step-10
    name: Update Asset Inventory
    action_type: update_asset
    description: Mark the host as compromised in asset inventory
    parameters:
      host_id: "{{alert.host_id}}"
      status: compromised
      tags:
        - malware-incident
        - isolated
        - "incident-{{execution.ticket_id}}"
    depends_on:
      - step-1
    on_failure: continue

tags:
  - malware
  - endpoint
  - incident-response
  - automated-response

metadata:
  author: Security Team
  created_at: "2024-01-10T00:00:00Z"
  updated_at: "2024-01-22T00:00:00Z"
  review_status: approved
  estimated_duration_minutes: 120
  compliance:
    - SOC2
    - NIST-CSF
    - ISO27001
