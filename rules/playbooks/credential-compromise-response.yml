id: "pb-credential-compromise-001"
name: "Credential Compromise Response"
description: |
  Automated response playbook for handling credential compromise alerts.

  This playbook is triggered by high/critical severity alerts related to
  credential compromise, brute force attacks, or impossible travel detections.

  Actions:
  1. Terminates all active user sessions
  2. Forces a password reset (requires approval)
  3. Creates an incident ticket in Jira
  4. Notifies the security team via Slack
version: "1.0.0"
author: "Mantissa Security Team"
created: "2025-01-27T00:00:00Z"
modified: "2025-01-27T00:00:00Z"
enabled: true
tags:
  - credential
  - identity
  - itdr
  - automated
  - high-priority

trigger:
  trigger_type: alert
  conditions:
    severity:
      - high
      - critical
    rule_patterns:
      - "*credential*"
      - "*brute_force*"
      - "*impossible_travel*"
      - "*password_spray*"
    tags:
      - identity

steps:
  - id: terminate_sessions
    name: "Terminate Active Sessions"
    action_type: terminate_sessions
    provider: auto
    parameters:
      user_email: "{{ alert.metadata.user_email }}"
      reason: "Security incident - credential compromise detected"
    timeout_seconds: 120
    on_success: force_password_reset
    on_failure: notify_error

  - id: force_password_reset
    name: "Force Password Reset"
    action_type: force_password_reset
    provider: auto
    parameters:
      user_email: "{{ alert.metadata.user_email }}"
      notify_user: true
      message: "Your password has been reset due to a security incident. Please contact IT if you did not request this change."
    requires_approval: true
    approval_roles:
      - security_analyst
      - security_manager
      - soc_tier2
    timeout_seconds: 3600
    on_success: create_ticket
    on_failure: notify_error

  - id: create_ticket
    name: "Create Incident Ticket"
    action_type: create_ticket
    provider: jira
    parameters:
      project: "SEC"
      issue_type: "Incident"
      summary: "Credential Compromise - {{ alert.metadata.user_email }}"
      description: |
        ## Security Incident Details

        **Alert:** {{ alert.title }}
        **Rule:** {{ alert.rule_name }}
        **Severity:** {{ alert.severity }}
        **Time:** {{ alert.timestamp }}

        ## Affected User
        - Email: {{ alert.metadata.user_email }}
        - User ID: {{ alert.metadata.user_id | default('N/A') }}

        ## Source Information
        - IP Address: {{ alert.metadata.source_ip | default('N/A') }}
        - Location: {{ alert.metadata.source_geo.country | default('Unknown') }}, {{ alert.metadata.source_geo.city | default('Unknown') }}
        - User Agent: {{ alert.metadata.user_agent | default('N/A') }}

        ## Automated Actions Taken
        1. Active sessions terminated: {{ steps.terminate_sessions.output.session_count | default(0) }} sessions
        2. Password reset initiated: {{ steps.force_password_reset.output.success | default(false) }}

        ## Investigation Notes
        _Add investigation findings here_

        ## Resolution
        _Document resolution steps here_
      priority: "High"
      labels:
        - security-incident
        - credential-compromise
        - automated-response
      assignee: "{{ alert.metadata.assigned_analyst | default('') }}"
    timeout_seconds: 60
    on_success: notify_success

  - id: notify_success
    name: "Notify Security Team - Success"
    action_type: notify
    provider: slack
    parameters:
      channel: "#security-alerts"
      message: |
        :white_check_mark: *Credential Compromise Response Completed*

        *User:* {{ alert.metadata.user_email }}
        *Alert:* {{ alert.title }}
        *Severity:* {{ alert.severity }}

        *Actions Taken:*
        • Sessions terminated: {{ steps.terminate_sessions.output.session_count | default(0) }}
        • Password reset: {{ 'Completed' if steps.force_password_reset.output.success else 'Pending' }}
        • Ticket created: {{ steps.create_ticket.output.ticket_id | default('N/A') }}

        <{{ steps.create_ticket.output.ticket_url | default('#') }}|View Ticket>

  - id: notify_error
    name: "Notify Security Team - Error"
    action_type: notify
    provider: slack
    parameters:
      channel: "#security-alerts"
      message: |
        :x: *Credential Compromise Response Failed*

        *User:* {{ alert.metadata.user_email }}
        *Alert:* {{ alert.title }}
        *Failed Step:* {{ failed_step | default('Unknown') }}
        *Error:* {{ error | default('Unknown error') }}

        *Manual intervention required!*

        <{{ alert.metadata.dashboard_link | default('#') }}|View in Dashboard>
