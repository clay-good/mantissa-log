name: "Encryption Configuration Removed"
description: "Detects when encryption is disabled on resources like S3 buckets or EBS volumes"
enabled: true
severity: "medium"
category: "cloud"

query: |
  SELECT
    useridentity.principalid as performed_by,
    eventname,
    eventsource,
    requestparameters.bucketName as bucket_name,
    requestparameters.volumeId as volume_id,
    sourceipaddress,
    eventtime
  FROM cloudtrail
  WHERE errorcode IS NULL
    AND eventtime > CURRENT_TIMESTAMP - INTERVAL '1' HOUR
    AND (
      (eventsource = 's3.amazonaws.com' AND eventname IN ('DeleteBucketEncryption', 'PutBucketEncryption'))
      OR (eventsource = 'ec2.amazonaws.com' AND eventname = 'DisableEbsEncryptionByDefault')
    )

threshold:
  count: 1
  window: "1h"

metadata:
  mitre_attack:
    - "T1485"
    - "T1486"
  tags:
    - "cloud"
    - "encryption"
    - "data-protection"
    - "cloudtrail"
  false_positives:
    - "Authorized encryption policy changes"
    - "Migration to different encryption method"
    - "Temporary encryption removal for troubleshooting"
  response_actions:
    - "Verify if encryption removal is authorized"
    - "Check if data is sensitive and requires encryption"
    - "Re-enable encryption if unauthorized"
    - "Review compliance requirements"
    - "Investigate who performed the action"
    - "Check for data access during unencrypted period"
    - "Verify encryption is re-enabled promptly"
  references:
    - "https://attack.mitre.org/techniques/T1485/"
    - "https://docs.aws.amazon.com/AmazonS3/latest/userguide/default-bucket-encryption.html"
    - "https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html"
  notes:
    - "Encryption at rest is critical for data protection"
    - "Many compliance frameworks require encryption"
    - "Consider enabling encryption by default at account level"
    - "Monitor for both S3 and EBS encryption changes"
