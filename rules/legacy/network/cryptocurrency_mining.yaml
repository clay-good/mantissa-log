name: "Cryptocurrency Mining Activity"
description: "Detects outbound connections to known cryptocurrency mining pools"
enabled: true
severity: "medium"
category: "network"

query: |
  SELECT
    srcaddr,
    dstaddr,
    dstport,
    COUNT(*) as connection_count,
    MIN(start_time) as first_connection,
    MAX(end_time) as last_connection,
    'Connection to known mining pool' as reason
  FROM vpc_flow_logs
  WHERE action = 'ACCEPT'
    AND start_time > CAST(CURRENT_TIMESTAMP - INTERVAL '1' HOUR AS BIGINT)
    AND (
      dstport IN (3333, 4444, 5555, 7777, 8888, 9999, 14433, 14444, 45560, 45700)
      OR dstaddr IN (
        '192.99.142.249',
        '51.15.89.151',
        '104.238.221.81'
      )
    )
  GROUP BY srcaddr, dstaddr, dstport

threshold:
  count: 1
  window: "1h"

metadata:
  mitre_attack:
    - "T1496"
  tags:
    - "network"
    - "cryptocurrency"
    - "cryptomining"
    - "resource-hijacking"
    - "vpc-flow-logs"
  false_positives:
    - "Authorized cryptocurrency operations"
    - "Blockchain development environments"
    - "Financial analysis systems"
  response_actions:
    - "Immediately investigate source instance"
    - "Check CPU utilization for abnormal spikes"
    - "Review running processes on the instance"
    - "Scan for malware and cryptominers"
    - "Check if this is authorized cryptocurrency activity"
    - "Review recent security group and IAM changes"
    - "Isolate instance if compromised"
    - "Review billing for unexpected compute costs"
  references:
    - "https://attack.mitre.org/techniques/T1496/"
  tuning:
    - "Update mining pool IP list regularly"
    - "Add known legitimate mining destinations if applicable"
    - "Monitor for connections to any IP on common mining ports"
    - "Consider correlation with high CPU usage"
  notes:
    - "Cryptomining pools frequently change IPs and ports"
    - "This list includes common pools but is not exhaustive"
    - "Consider network-based blocking of mining pools"
    - "Cryptomining malware often uses stratum protocol"
    - "High CPU usage + mining pool connections = high confidence"
    - "Update mining pool indicators regularly from threat intelligence"
