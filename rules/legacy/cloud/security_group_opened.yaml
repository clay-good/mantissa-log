name: "Security Group Opened to Internet"
description: "Detects security group rules allowing broad internet access to sensitive ports"
enabled: true
severity: "high"
category: "cloud"

query: |
  SELECT
    useridentity.principalid as changed_by,
    requestparameters.groupId as security_group,
    eventname,
    sourceipaddress,
    eventtime,
    requestparameters
  FROM cloudtrail
  WHERE eventname = 'AuthorizeSecurityGroupIngress'
    AND errorcode IS NULL
    AND eventtime > CURRENT_TIMESTAMP - INTERVAL '1' HOUR
    AND (
      CAST(requestparameters AS VARCHAR) LIKE '%0.0.0.0/0%'
      OR CAST(requestparameters AS VARCHAR) LIKE '%::/0%'
    )
    AND (
      CAST(requestparameters AS VARCHAR) LIKE '%"toPort":22%'
      OR CAST(requestparameters AS VARCHAR) LIKE '%"toPort":3389%'
      OR CAST(requestparameters AS VARCHAR) LIKE '%"toPort":1433%'
      OR CAST(requestparameters AS VARCHAR) LIKE '%"toPort":3306%'
      OR CAST(requestparameters AS VARCHAR) LIKE '%"toPort":5432%'
      OR CAST(requestparameters AS VARCHAR) LIKE '%"toPort":5439%'
      OR CAST(requestparameters AS VARCHAR) LIKE '%"toPort":6379%'
      OR CAST(requestparameters AS VARCHAR) LIKE '%"toPort":27017%'
      OR CAST(requestparameters AS VARCHAR) LIKE '%"toPort":9200%'
    )

threshold:
  count: 1
  window: "1h"

metadata:
  mitre_attack:
    - "T1190"
    - "T1133"
  tags:
    - "cloud"
    - "security-group"
    - "network-exposure"
    - "cloudtrail"
  false_positives:
    - "Temporary rules for troubleshooting"
    - "Specific administrative needs"
    - "Load balancer or proxy configurations"
  response_actions:
    - "Review if the change is authorized"
    - "Identify instances affected by this security group"
    - "Verify if broad access is necessary"
    - "Consider using more restrictive CIDR ranges"
    - "Implement VPN or bastion host access instead"
    - "Revert change if unauthorized"
    - "Review recent login attempts to affected instances"
  references:
    - "https://attack.mitre.org/techniques/T1190/"
    - "https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html"
  notes:
    - "Sensitive ports should never be open to 0.0.0.0/0"
    - "Use AWS Systems Manager Session Manager instead of SSH/RDP"
    - "Common sensitive ports: SSH (22), RDP (3389), databases"
    - "Consider automated remediation for this violation"
