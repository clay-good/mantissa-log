name: "Port Scanning Detected"
description: "Detects potential port scanning activity where a source attempts connections to many different ports"
enabled: true
severity: "medium"
category: "network"

query: |
  SELECT
    srcaddr,
    COUNT(DISTINCT dstport) as unique_ports,
    COUNT(*) as total_connections,
    MIN(start_time) as first_scan,
    MAX(end_time) as last_scan,
    ARRAY_AGG(DISTINCT dstport ORDER BY dstport) as scanned_ports
  FROM vpc_flow_logs
  WHERE start_time > CAST(CURRENT_TIMESTAMP - INTERVAL '5' MINUTE AS BIGINT)
    AND action = 'REJECT'
  GROUP BY srcaddr
  HAVING COUNT(DISTINCT dstport) > 50

threshold:
  count: 1
  window: "5m"

metadata:
  mitre_attack:
    - "T1046"
  tags:
    - "network"
    - "reconnaissance"
    - "port-scan"
    - "vpc-flow-logs"
  false_positives:
    - "Network monitoring tools"
    - "Vulnerability scanners (authorized)"
    - "Load balancer health checks"
    - "Misconfigured applications trying multiple ports"
  response_actions:
    - "Identify source IP and verify if internal or external"
    - "Check if this is authorized security scanning"
    - "Review recent security group changes"
    - "Consider blocking source IP if malicious"
    - "Investigate what assets were scanned"
    - "Review security group rules for overly permissive access"
    - "Enable VPC Flow Logs if not already enabled"
  references:
    - "https://attack.mitre.org/techniques/T1046/"
    - "https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html"
  tuning:
    - "Adjust port count threshold based on environment"
    - "Consider separate rules for internal vs external sources"
    - "Whitelist known vulnerability scanners"
    - "May need different thresholds for different VPCs"
  notes:
    - "This rule looks for REJECT actions indicating unsuccessful connections"
    - "Successful port scans may not trigger if security groups allow access"
    - "Consider correlating with other reconnaissance indicators"
