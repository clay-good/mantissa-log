name: "Unusual Outbound Port Connection"
description: "Detects outbound connections to uncommon ports that may indicate command and control or backdoor activity"
enabled: false
severity: "low"
category: "network"

query: |
  SELECT
    srcaddr,
    dstaddr,
    dstport,
    COUNT(*) as connection_count,
    MIN(start_time) as first_seen,
    MAX(end_time) as last_seen
  FROM vpc_flow_logs
  WHERE action = 'ACCEPT'
    AND start_time > CAST(CURRENT_TIMESTAMP - INTERVAL '1' HOUR AS BIGINT)
    AND dstport NOT IN (
      20, 21, 22, 23, 25, 53, 80, 110, 143, 443, 465, 587, 993, 995,
      1433, 1521, 3306, 3389, 5432, 5439, 6379, 8080, 8443, 9200, 9300, 27017
    )
  GROUP BY srcaddr, dstaddr, dstport
  HAVING COUNT(*) > 10

threshold:
  count: 1
  window: "1h"

metadata:
  mitre_attack:
    - "T1071"
    - "T1571"
  tags:
    - "network"
    - "c2"
    - "unusual-port"
    - "vpc-flow-logs"
  false_positives:
    - "Custom applications on non-standard ports"
    - "Internal services"
    - "Database replication on custom ports"
    - "Monitoring and management tools"
    - "Container orchestration traffic"
  response_actions:
    - "Identify source and destination instances"
    - "Verify if application requires this port"
    - "Check if port is documented for the service"
    - "Investigate if destination is external"
    - "Review application configuration"
    - "Consider if this is command and control traffic"
  references:
    - "https://attack.mitre.org/techniques/T1071/"
    - "https://attack.mitre.org/techniques/T1571/"
  tuning:
    - "Add commonly used ports in your environment to exclusion list"
    - "Consider enabling only for specific critical instances"
    - "Requires significant tuning to reduce false positives"
    - "May want to focus on external destinations only"
  notes:
    - "This rule is disabled by default due to high false positive rate"
    - "Useful for investigation and understanding traffic patterns"
    - "Consider creating targeted rules for specific suspicious ports"
    - "Best used with network segmentation and micro-segmentation"
