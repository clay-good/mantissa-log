name: "Potential Data Exfiltration"
description: "Detects large outbound data transfers to external IP addresses that may indicate data exfiltration"
enabled: true
severity: "high"
category: "network"

query: |
  SELECT
    srcaddr,
    dstaddr,
    dstport,
    SUM(bytes) as total_bytes,
    COUNT(*) as connection_count,
    MIN(start_time) as first_seen,
    MAX(end_time) as last_seen
  FROM vpc_flow_logs
  WHERE action = 'ACCEPT'
    AND bytes > 0
    AND start_time > CAST(CURRENT_TIMESTAMP - INTERVAL '1' HOUR AS BIGINT)
    AND dstaddr NOT LIKE '10.%'
    AND dstaddr NOT LIKE '172.16.%'
    AND dstaddr NOT LIKE '172.17.%'
    AND dstaddr NOT LIKE '172.18.%'
    AND dstaddr NOT LIKE '172.19.%'
    AND dstaddr NOT LIKE '172.20.%'
    AND dstaddr NOT LIKE '172.21.%'
    AND dstaddr NOT LIKE '172.22.%'
    AND dstaddr NOT LIKE '172.23.%'
    AND dstaddr NOT LIKE '172.24.%'
    AND dstaddr NOT LIKE '172.25.%'
    AND dstaddr NOT LIKE '172.26.%'
    AND dstaddr NOT LIKE '172.27.%'
    AND dstaddr NOT LIKE '172.28.%'
    AND dstaddr NOT LIKE '172.29.%'
    AND dstaddr NOT LIKE '172.30.%'
    AND dstaddr NOT LIKE '172.31.%'
    AND dstaddr NOT LIKE '192.168.%'
  GROUP BY srcaddr, dstaddr, dstport
  HAVING SUM(bytes) > 1073741824

threshold:
  count: 1
  window: "1h"

metadata:
  mitre_attack:
    - "T1041"
    - "T1048"
  tags:
    - "network"
    - "exfiltration"
    - "vpc-flow-logs"
    - "data-transfer"
  false_positives:
    - "Legitimate large file transfers"
    - "Backup operations to cloud storage"
    - "Content delivery to external services"
    - "Database replication to external systems"
    - "Video streaming or media downloads"
  response_actions:
    - "Identify the source instance and its purpose"
    - "Investigate destination IP reputation"
    - "Review what data the source instance has access to"
    - "Check application logs for legitimate transfer reasons"
    - "Consider blocking destination if malicious"
    - "Review security group and NACL configurations"
    - "Investigate if source instance is compromised"
  references:
    - "https://attack.mitre.org/techniques/T1041/"
    - "https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html"
  tuning:
    - "Adjust threshold based on normal traffic patterns"
    - "Add known good destinations to exclusion list"
    - "Consider separate rules for different environments"
    - "Monitor for sustained transfers vs bursts"
  notes:
    - "1GB threshold may need adjustment for your environment"
    - "Consider implementing DLP solutions for sensitive data"
    - "VPC Flow Logs show network traffic, not payload content"
