title: Azure AD Credential Stuffing Attack
id: itdr-azure-credential-stuffing-001
status: stable
description: |
  Detects credential stuffing attacks against Azure Active Directory.
  Triggers when 20+ unique users are attempted from the same IP within 10 minutes,
  OR when a mix of 5+ successes and 10+ failures occur from the same IP.
  Credential stuffing uses leaked credentials from breaches, often with
  automation showing consistent timing and user agent patterns.
author: Mantissa ITDR Team
date: 2025-01-28
modified: 2025-01-28

logsource:
  product: azure
  service: signinlogs

detection:
  selection:
    category: 'SignInLogs'
  filter_internal:
    properties.ipAddress:
      - '127.0.0.1'
      - '::1'
  condition: selection and not filter_internal | count(properties.userPrincipalName) by properties.ipAddress >= 20
  timeframe: 10m

fields:
  - properties.ipAddress
  - properties.userPrincipalName
  - properties.status.errorCode
  - properties.status.failureReason
  - properties.userAgent
  - properties.deviceDetail.browser
  - properties.deviceDetail.operatingSystem
  - properties.location.countryOrRegion
  - properties.location.city
  - properties.riskState
  - properties.riskLevelDuringSignIn
  - '@timestamp'

falsepositives:
  - Corporate proxy/NAT environments
  - VPN concentrators
  - Shared workspaces with many users
  - Azure AD Connect sync operations

level: critical

tags:
  - attack.credential_access
  - attack.t1110.004  # Brute Force: Credential Stuffing
  - attack.t1078.004  # Valid Accounts: Cloud Accounts
  - itdr
  - identity

references:
  - https://attack.mitre.org/techniques/T1110/004/
  - https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-sign-ins
  - https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/overview-identity-protection

custom:
  itdr_category: credential_attack
  itdr_subcategory: credential_stuffing
  provider: azure
  detection_thresholds:
    unique_user_threshold: 20
    time_window_minutes: 10
    success_threshold: 5
    failure_threshold: 10
  azure_risk_indicators:
    - riskState: atRisk
    - riskLevelDuringSignIn: high
    - riskEventTypes: unfamiliarFeatures, maliciousIPAddress
  azure_error_codes:
    50126: "Invalid username or password"
    50053: "Account is locked"
    50055: "Password expired"
    50074: "Strong authentication required"
  recommended_action: |
    1. Block the source IP in Azure AD Conditional Access
    2. Review Azure AD Identity Protection risk events
    3. Force password reset for compromised accounts
    4. Enable risk-based Conditional Access policies
    5. Check Microsoft Threat Intelligence for IP reputation
    6. Review sign-in logs for successful authentications
