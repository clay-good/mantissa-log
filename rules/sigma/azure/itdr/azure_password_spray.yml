title: Azure AD Password Spray Attack
id: itdr-azure-password-spray-001
status: stable
description: |
  Detects password spray attacks against Azure Active Directory.
  Uses Azure Identity Protection's passwordSpray risk detection when available,
  with fallback to pattern-based detection (10+ unique users, < 3 failures per user).
  Password spray attacks are low-and-slow to evade lockouts.
author: Mantissa ITDR Team
date: 2025-01-28
modified: 2025-01-28

logsource:
  product: azure
  service: signinlogs

detection:
  selection_risk:
    # Azure Identity Protection built-in spray detection
    properties.riskEventTypes_v2|contains: 'passwordSpray'
  selection_pattern:
    # Fallback pattern-based detection
    properties.status.errorCode:
      - 50126  # Invalid username or password
      - 50053  # Account is locked
  condition: selection_risk or (selection_pattern | count(properties.userPrincipalName) by properties.ipAddress >= 10)
  timeframe: 60m

fields:
  - properties.ipAddress
  - properties.userPrincipalName
  - properties.status.errorCode
  - properties.status.failureReason
  - properties.riskEventTypes_v2
  - properties.riskState
  - properties.riskLevelDuringSignIn
  - properties.userAgent
  - properties.deviceDetail.browser
  - properties.deviceDetail.operatingSystem
  - properties.location.countryOrRegion
  - properties.location.city
  - '@timestamp'

falsepositives:
  - Azure AD Connect sync issues
  - Bulk password reset operations
  - Directory synchronization errors
  - Security testing

level: critical

tags:
  - attack.credential_access
  - attack.t1110.003  # Brute Force: Password Spraying
  - attack.t1078.004  # Valid Accounts: Cloud Accounts
  - itdr
  - identity

references:
  - https://attack.mitre.org/techniques/T1110/003/
  - https://docs.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-risks
  - https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-sign-ins

custom:
  itdr_category: credential_attack
  itdr_subcategory: password_spray
  provider: azure
  detection_thresholds:
    min_users_targeted: 10
    max_attempts_per_user: 3
    time_window_minutes: 60
  azure_risk_detection:
    passwordSpray: "Azure Identity Protection spray detection"
    unfamiliarFeatures: "Anomalous sign-in properties"
    anonymizedIPAddress: "TOR or anonymous proxy"
  azure_error_codes:
    50126: "Invalid username or password"
    50053: "Account is locked"
    50055: "Password expired"
    50057: "User account disabled"
  recommended_action: |
    1. Block the source IP in Conditional Access
    2. Review Azure Identity Protection risk events
    3. Check sign-in logs for successful logins from this IP
    4. Force password reset for any compromised accounts
    5. Enable Password Protection with custom banned passwords
    6. Consider Smart Lockout configuration
