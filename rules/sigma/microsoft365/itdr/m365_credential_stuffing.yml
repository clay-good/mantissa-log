title: Microsoft 365 Credential Stuffing Attack
id: itdr-m365-credential-stuffing-001
status: stable
description: |
  Detects credential stuffing attacks against Microsoft 365 services.
  Triggers when 20+ unique users are attempted from the same IP within 10 minutes.
  Credential stuffing uses leaked credentials from breaches, often targeting
  Exchange, SharePoint, OneDrive, and Teams authentication.
author: Mantissa ITDR Team
date: 2025-01-28
modified: 2025-01-28

logsource:
  product: microsoft365
  service: audit

detection:
  selection:
    Operation:
      - 'UserLoginFailed'
      - 'UserLoggedIn'
  filter_internal:
    ClientIP:
      - '127.0.0.1'
      - '::1'
  condition: selection and not filter_internal | count(UserId) by ClientIP >= 20
  timeframe: 10m

fields:
  - ClientIP
  - UserId
  - Operation
  - ResultStatus
  - Workload
  - LogonError
  - UserAgent
  - ClientInfoString
  - ExternalAccess
  - OrganizationId
  - '@timestamp'

falsepositives:
  - Corporate proxy/NAT environments
  - VPN concentrators
  - Outlook client with multiple account sync
  - Migration tools during tenant transitions

level: critical

tags:
  - attack.credential_access
  - attack.t1110.004  # Brute Force: Credential Stuffing
  - attack.t1078.004  # Valid Accounts: Cloud Accounts
  - itdr
  - identity

references:
  - https://attack.mitre.org/techniques/T1110/004/
  - https://docs.microsoft.com/en-us/office/office-365-management-api/office-365-management-activity-api-schema
  - https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-illicit-consent-grants

custom:
  itdr_category: credential_attack
  itdr_subcategory: credential_stuffing
  provider: microsoft365
  detection_thresholds:
    unique_user_threshold: 20
    time_window_minutes: 10
    success_threshold: 5
    failure_threshold: 10
  m365_workloads:
    - Exchange
    - SharePoint
    - OneDrive
    - Teams
    - AzureActiveDirectory
  m365_logon_errors:
    - "InvalidUserNameOrPassword"
    - "UserAccountNotFound"
    - "UserAccountLocked"
    - "ExpiredPassword"
  recommended_action: |
    1. Block the source IP in Microsoft 365 Conditional Access
    2. Review successful logins from this IP across all workloads
    3. Force password reset for affected accounts
    4. Check Microsoft Defender for Cloud Apps alerts
    5. Review unified audit log for post-compromise activity
    6. Enable Safe Links and Safe Attachments if not already
