title: Microsoft 365 Password Spray Attack
id: itdr-m365-password-spray-001
status: stable
description: |
  Detects password spray attacks against Microsoft 365 services.
  Triggers when an IP targets 10+ unique users with fewer than 3 failures per user
  within 1 hour. Password spray attacks target Exchange, SharePoint, OneDrive,
  and Teams authentication with common passwords.
author: Mantissa ITDR Team
date: 2025-01-28
modified: 2025-01-28

logsource:
  product: microsoft365
  service: audit

detection:
  selection:
    Operation: 'UserLoginFailed'
    ResultStatus: 'Failed'
  condition: selection | count(UserId) by ClientIP >= 10
  timeframe: 60m

fields:
  - ClientIP
  - UserId
  - Operation
  - ResultStatus
  - Workload
  - LogonError
  - UserAgent
  - ClientInfoString
  - OrganizationId
  - '@timestamp'

falsepositives:
  - Outlook client with multiple accounts
  - Teams desktop app sync issues
  - SharePoint migration operations
  - Security testing

level: critical

tags:
  - attack.credential_access
  - attack.t1110.003  # Brute Force: Password Spraying
  - attack.t1078.004  # Valid Accounts: Cloud Accounts
  - itdr
  - identity

references:
  - https://attack.mitre.org/techniques/T1110/003/
  - https://docs.microsoft.com/en-us/office/office-365-management-api/office-365-management-activity-api-schema
  - https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/detect-and-remediate-outlook-rules-forms-attack

custom:
  itdr_category: credential_attack
  itdr_subcategory: password_spray
  provider: microsoft365
  detection_thresholds:
    min_users_targeted: 10
    max_attempts_per_user: 3
    time_window_minutes: 60
  m365_workloads:
    - Exchange
    - SharePoint
    - OneDrive
    - Teams
    - AzureActiveDirectory
  m365_logon_errors:
    - "InvalidUserNameOrPassword"
    - "UserAccountLocked"
    - "ExpiredPassword"
  recommended_action: |
    1. Block the source IP in Microsoft 365 Conditional Access
    2. Check unified audit log for successful logins from this IP
    3. Force password reset for compromised accounts
    4. Review Microsoft Defender for Cloud Apps alerts
    5. Enable Azure AD Password Protection
    6. Consider blocking legacy authentication protocols
