title: Okta Password Spray Attack
id: itdr-okta-password-spray-001
status: stable
description: |
  Detects password spray attacks against Okta.
  Triggers when an IP targets 10+ unique users with fewer than 3 failures per user
  within 1 hour. Password spray attacks are low-and-slow, staying below lockout
  thresholds while testing common passwords against many accounts.
author: Mantissa ITDR Team
date: 2025-01-28
modified: 2025-01-28

logsource:
  product: okta
  service: system

detection:
  selection:
    event.action: 'user.session.start'
    event.outcome: 'failure'
  # Pattern: 10+ unique users, but < 3 failures per user (avg)
  # This Sigma rule captures the raw events; aggregation logic is in detector
  condition: selection | count(user.email) by source.ip >= 10
  timeframe: 60m

fields:
  - source.ip
  - user.email
  - user.name
  - event.outcome
  - okta.outcome.reason
  - okta.client.userAgent.rawUserAgent
  - okta.client.device
  - okta.client.zone
  - source.geo.country_name
  - source.geo.city_name
  - '@timestamp'

falsepositives:
  - SSO redirects with session issues
  - Password reset campaigns
  - Bulk account provisioning tests
  - Penetration testing activities

level: critical

tags:
  - attack.credential_access
  - attack.t1110.003  # Brute Force: Password Spraying
  - attack.t1078      # Valid Accounts
  - itdr
  - identity

references:
  - https://attack.mitre.org/techniques/T1110/003/
  - https://developer.okta.com/docs/reference/api/system-log/
  - https://www.microsoft.com/en-us/security/blog/2020/04/23/protecting-organization-password-spray-attacks/

custom:
  itdr_category: credential_attack
  itdr_subcategory: password_spray
  provider: okta
  detection_thresholds:
    min_users_targeted: 10
    max_attempts_per_user: 3
    time_window_minutes: 60
  spray_characteristics:
    - Low attempts per user (below lockout threshold)
    - Many unique users targeted
    - Evenly distributed timing
    - Common password patterns
  recommended_action: |
    1. Block the source IP immediately
    2. Check if any targeted users had subsequent successful logins
    3. Force password reset for any compromised accounts
    4. Review if common/weak passwords were used
    5. Implement smart lockout policies
    6. Consider requiring MFA for all affected users
