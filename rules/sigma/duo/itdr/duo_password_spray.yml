title: Duo Security Password Spray Attack
id: itdr-duo-password-spray-001
status: stable
description: |
  Detects password spray attacks through Duo Security MFA.
  Triggers when an IP targets 10+ unique users with fewer than 3 failures per user
  within 1 hour. Note: Duo typically handles second factor, so spray patterns here
  indicate primary authentication issues or bypass attempts.
author: Mantissa ITDR Team
date: 2025-01-28
modified: 2025-01-28

logsource:
  product: duo
  service: authentication

detection:
  selection:
    result: 'DENIED'
    reason:
      - 'invalid_credentials'
      - 'user_disabled'
      - 'deny_unenrolled_user'
  condition: selection | count(user.name) by access_device.ip >= 10
  timeframe: 60m

fields:
  - access_device.ip
  - user.name
  - user.key
  - result
  - reason
  - factor
  - integration.name
  - integration.key
  - access_device.location.country
  - access_device.location.city
  - access_device.hostname
  - '@timestamp'

falsepositives:
  - VPN concentrator with many users
  - Citrix/VDI environment issues
  - Service desk password reset operations
  - Duo enrollment campaigns

level: critical

tags:
  - attack.credential_access
  - attack.t1110.003  # Brute Force: Password Spraying
  - attack.t1556.006  # Modify Authentication Process: MFA
  - itdr
  - identity

references:
  - https://attack.mitre.org/techniques/T1110/003/
  - https://duo.com/docs/adminapi#authentication-logs
  - https://duo.com/docs/policy

custom:
  itdr_category: credential_attack
  itdr_subcategory: password_spray
  provider: duo
  detection_thresholds:
    min_users_targeted: 10
    max_attempts_per_user: 3
    time_window_minutes: 60
  duo_denial_reasons:
    invalid_credentials: "Primary auth failed before Duo"
    user_disabled: "User account disabled"
    deny_unenrolled_user: "User not enrolled in Duo"
    locked_out: "User account locked"
  recommended_action: |
    1. Block the source IP at network perimeter
    2. Correlate with primary authentication logs
    3. Review Duo Trust Monitor for anomalies
    4. Force password reset for affected accounts
    5. Review Duo Policy configurations
    6. Consider Duo Risk-Based Authentication
