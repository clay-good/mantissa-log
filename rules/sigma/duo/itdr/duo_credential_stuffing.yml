title: Duo Security Credential Stuffing Attack
id: itdr-duo-credential-stuffing-001
status: stable
description: |
  Detects credential stuffing attacks through Duo Security MFA.
  Triggers when 20+ unique users are attempted from the same IP within 10 minutes.
  Note: Duo is typically the second factor, so credential stuffing here indicates
  the primary authentication was bypassed or compromised.
author: Mantissa ITDR Team
date: 2025-01-28
modified: 2025-01-28

logsource:
  product: duo
  service: authentication

detection:
  selection:
    event_type: 'authentication'
  filter_internal:
    access_device.ip:
      - '127.0.0.1'
      - '::1'
  condition: selection and not filter_internal | count(user.name) by access_device.ip >= 20
  timeframe: 10m

fields:
  - access_device.ip
  - user.name
  - user.key
  - result
  - reason
  - factor
  - integration.name
  - integration.key
  - access_device.location.country
  - access_device.location.city
  - access_device.hostname
  - access_device.epkey
  - '@timestamp'

falsepositives:
  - Large enterprise VPN concentrators
  - Shared workspace environments
  - Terminal server deployments
  - Citrix/VDI environments with shared egress

level: critical

tags:
  - attack.credential_access
  - attack.t1110.004  # Brute Force: Credential Stuffing
  - attack.t1556.006  # Modify Authentication Process: MFA
  - itdr
  - identity

references:
  - https://attack.mitre.org/techniques/T1110/004/
  - https://duo.com/docs/adminapi#authentication-logs
  - https://duo.com/docs/policy

custom:
  itdr_category: credential_attack
  itdr_subcategory: credential_stuffing
  provider: duo
  detection_thresholds:
    unique_user_threshold: 20
    time_window_minutes: 10
    success_threshold: 5
    failure_threshold: 10
  duo_result_types:
    SUCCESS: "Authentication approved"
    FAILURE: "Authentication denied"
    FRAUD: "User reported fraud"
  duo_denial_reasons:
    invalid_credentials: "Primary auth failed"
    user_disabled: "User is disabled"
    locked_out: "User is locked out"
    deny_unenrolled_user: "User not enrolled in Duo"
    user_not_in_permitted_group: "User not in permitted group"
  recommended_action: |
    1. Block the source IP at network perimeter
    2. Review primary authentication logs for same IP
    3. Force password reset for affected accounts
    4. Review Duo Trust Monitor for anomalies
    5. Consider enabling Remembered Devices restrictions
    6. Check for MFA fatigue attack patterns
