name: "Impossible Travel Detection"
description: "Detects successful logins from geographically distant locations within a short time period, indicating potential account compromise"
enabled: true
severity: "high"
category: "authentication"

query: |
  WITH successful_logins AS (
    SELECT
      useridentity.principalid as user,
      sourceipaddress,
      eventtime,
      ROW_NUMBER() OVER (PARTITION BY useridentity.principalid ORDER BY eventtime) as login_seq
    FROM cloudtrail
    WHERE eventname = 'ConsoleLogin'
      AND errorcode IS NULL
      AND eventtime > CURRENT_TIMESTAMP - INTERVAL '6' HOUR
  ),
  login_pairs AS (
    SELECT
      l1.user,
      l1.sourceipaddress as ip1,
      l2.sourceipaddress as ip2,
      l1.eventtime as time1,
      l2.eventtime as time2,
      (CAST(l2.eventtime AS TIMESTAMP) - CAST(l1.eventtime AS TIMESTAMP)) AS time_diff_seconds
    FROM successful_logins l1
    JOIN successful_logins l2
      ON l1.user = l2.user
      AND l1.login_seq = l2.login_seq - 1
      AND l1.sourceipaddress != l2.sourceipaddress
  )
  SELECT
    user,
    ip1 as first_ip,
    ip2 as second_ip,
    time1 as first_login,
    time2 as second_login,
    time_diff_seconds / 60 as minutes_between_logins,
    'Logins from different IPs within short timeframe' as reason
  FROM login_pairs
  WHERE time_diff_seconds < 3600

threshold:
  count: 1
  window: "6h"

metadata:
  mitre_attack:
    - "T1078"  # Valid Accounts
    - "T1078.004"  # Cloud Accounts
  tags:
    - "authentication"
    - "impossible-travel"
    - "cloudtrail"
    - "account-compromise"
  false_positives:
    - "VPN usage causing IP address changes"
    - "Mobile users switching between WiFi and cellular"
    - "Corporate proxy infrastructure"
    - "Shared accounts (should be avoided)"
  response_actions:
    - "Immediately contact the account owner to verify activity"
    - "Review all actions performed during both sessions"
    - "Force password reset if compromise is confirmed"
    - "Enable MFA if not already enabled"
    - "Review CloudTrail logs for unauthorized actions"
    - "Consider temporary account suspension pending investigation"
  references:
    - "https://attack.mitre.org/techniques/T1078/"
  notes:
    - "This rule uses IP address differences as a proxy for geographic distance"
    - "For more accurate detection, integrate with IP geolocation service"
    - "Consider distance >500 miles in <1 hour as high-confidence indicator"
